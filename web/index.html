<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TDE-SPH Web Visualizer</title>

    <!-- Stylesheet -->
    <link rel="stylesheet" href="css/style.css">

    <!-- Three.js ESM imports via importmap -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
    }
    </script>
    
    <!-- Load Three.js and post-processing modules -->
    <script type="module">
        import * as THREE_MODULE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { ShaderPass } from 'three/addons/postprocessing/ShaderPass.js';
        import { Lut } from 'three/addons/math/Lut.js';
        
        // Create a mutable object that contains all THREE exports plus addons
        const THREE = Object.assign({}, THREE_MODULE, {
            OrbitControls,
            EffectComposer,
            RenderPass,
            UnrealBloomPass,
            ShaderPass,
            Lut
        });
        
        // Expose to global scope for non-module scripts
        window.THREE = THREE;
        
        // Dispatch event when Three.js is ready
        window.dispatchEvent(new Event('threejs-ready'));
    </script>
</head>
<body>
    <div id="app">
        <!-- Header (collapsible) -->
        <header id="header-banner">
            <div class="header-content">
                <h1>üåå TDE-SPH Web Visualizer</h1>
                <p>Interactive 3D visualization of tidal disruption events</p>
            </div>
            <button id="header-close-btn" class="header-close" title="Hide header">√ó</button>
        </header>

        <!-- Main content -->
        <div id="main-container">
            <!-- Left sidebar: Controls -->
            <aside id="sidebar">
                <div class="panel">
                    <h2>Data Source</h2>
                    <div class="control-group">
                        <label for="data-source">Source:</label>
                        <select id="data-source">
                            <option value="local">Local Files</option>
                            <option value="server">Simulation Server</option>
                            <option value="demo">Demo Data</option>
                        </select>
                    </div>

                    <div class="control-group" id="file-upload-group">
                        <label for="file-upload">Upload HDF5/JSON:</label>
                        <input type="file" id="file-upload" accept=".h5,.hdf5,.json" multiple>
                        <button id="load-files-btn" class="btn btn-primary">Load Files</button>
                        <div id="load-progress-wrap">
                            <label for="load-progress">Progress:</label>
                            <progress id="load-progress" value="0" max="100"></progress>
                            <span id="load-progress-text">0%</span>
                        </div>
                    </div>
                    
                    <div class="control-group" id="streaming-options">
                        <label>
                            <input type="checkbox" id="streaming-mode-checkbox">
                            Streaming Mode (large datasets)
                        </label>
                        <small>Loads snapshots on-demand to save RAM</small>
                    </div>
                    
                    <div class="control-group" id="memory-settings" style="display:none;">
                        <label for="ram-cache-slider">RAM Cache: <span id="ram-cache-value">16</span> GB</label>
                        <input type="range" id="ram-cache-slider" min="1" max="32" value="16" step="1">
                        <small>Max RAM for cached snapshots</small>
                    </div>
                    
                    <div class="control-group" id="spline-options" style="display:none;">
                        <button id="precompute-splines-btn" class="btn btn-primary">üîÑ Precompute Splines</button>
                        <small>Cache smooth interpolation to disk (may be large)</small>
                        <div id="spline-progress" style="display:none;">
                            <progress id="spline-progress-bar" value="0" max="100"></progress>
                            <span id="spline-progress-text">0%</span>
                        </div>
                        <div id="spline-status" style="margin-top:5px;"></div>
                    </div>

                    <div class="control-group" id="server-connect-group" style="display:none;">
                        <label for="server-url">Server URL:</label>
                        <input type="text" id="server-url" value="http://localhost:8000" placeholder="http://localhost:8000">
                        <button id="connect-server-btn" class="btn btn-primary">Connect</button>
                    </div>

                    <div class="control-group">
                        <button id="load-demo-btn" class="btn btn-success">Load Demo Data</button>
                    </div>
                    
                    <div class="control-group" id="cache-stats" style="display:none;">
                        <small>Cache: <span id="cache-stats-text">-</span></small>
                    </div>
                </div>

                <div class="panel">
                    <h2>Animation Control</h2>
                    <div class="control-group">
                        <button id="play-btn" class="btn btn-primary" disabled>‚ñ∂ Play</button>
                        <button id="pause-btn" class="btn btn-warning" disabled>‚è∏ Pause</button>
                        <button id="step-back-btn" class="btn" disabled>‚èÆ</button>
                        <button id="step-fwd-btn" class="btn" disabled>‚è≠</button>
                    </div>

                    <div class="control-group">
                        <label for="snapshot-slider">Snapshot: <span id="snapshot-index">0</span> / <span id="snapshot-count">0</span></label>
                        <input type="range" id="snapshot-slider" min="0" max="0" value="0" step="1" disabled>
                    </div>

                    <div class="control-group">
                        <label>
                            <input type="checkbox" id="interpolation-checkbox">
                            Smooth Interpolation
                        </label>
                    </div>

                    <div class="control-group">
                        <label for="playback-speed">Playback Speed: <span id="playback-speed-value">1.0x</span></label>
                        <input type="range" id="playback-speed" min="-4" max="1" value="0" step="0.1">
                        <small>Range: 0.0001x to 10x (logarithmic)</small>
                    </div>

                    <div class="control-group">
                        <label for="fps-slider">Max FPS: <span id="fps-value">60</span></label>
                        <input type="range" id="fps-slider" min="1" max="60" value="60" step="1">
                    </div>

                    <div class="control-group">
                        <label>Time: <span id="time-display">0.00</span></label>
                    </div>
                </div>

                <div class="panel">
                    <h2>Visualization</h2>
                    
                    <div class="control-group">
                        <label for="renderer-mode">Renderer:</label>
                        <select id="renderer-mode">
                            <option value="instanced">3D Instanced (1M+ particles)</option>
                            <option value="points">2D Points (legacy)</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <label for="color-by">Color By:</label>
                        <select id="color-by">
                            <option value="density">Density</option>
                            <option value="temperature">Temperature</option>
                            <option value="internal_energy">Internal Energy</option>
                            <option value="velocity_magnitude">Velocity Magnitude</option>
                            <option value="pressure">Pressure</option>
                            <option value="entropy">Entropy</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label for="colormap">Colormap:</label>
                        <select id="colormap">
                            <option value="blackbody">Blackbody (thermal)</option>
                            <option value="viridis">Viridis</option>
                            <option value="plasma">Plasma</option>
                            <option value="inferno">Inferno</option>
                            <option value="hot">Hot</option>
                            <option value="cool">Cool</option>
                            <option value="rainbow">Rainbow</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label for="point-size">Particle Size: <span id="point-size-value">0.1</span></label>
                        <input type="range" id="point-size" min="0.001" max="0.1" value="0.01" step="0.001">
                    </div>
                    
                    <div class="control-group">
                        <label for="max-size-mult">Max Size Multiplier: <span id="max-size-mult-value">2.0x</span></label>
                        <input type="range" id="max-size-mult" min="1" max="10" value="2" step="0.5">
                        <small>Max scaling for low-density particles</small>
                    </div>

                    <div class="control-group" id="point-shape-group">
                        <label for="point-shape">Point Shape (2D only):</label>
                        <select id="point-shape">
                            <option value="square">Square</option>
                            <option value="circle">Circle</option>
                            <option value="smooth">Smooth Circle</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label for="point-opacity">Base Opacity: <span id="point-opacity-value">1.00</span></label>
                        <input type="range" id="point-opacity" min="0.1" max="1" value="1" step="0.05">
                    </div>
                    
                    <div class="control-group">
                        <label for="opacity-scale">Opacity Scale: <span id="opacity-scale-value">1.0</span></label>
                        <input type="range" id="opacity-scale" min="-3" max="1" value="0" step="0.1">
                        <small>Log scale: 0.001 to 10</small>
                    </div>

                    <div class="control-group">
                        <label>
                            <input type="checkbox" id="size-by-density" checked>
                            Size by density (10th percentile baseline)
                        </label>
                    </div>

                    <div class="control-group">
                        <label>
                            <input type="checkbox" id="log-scale-checkbox" checked>
                            Logarithmic Color Scale
                        </label>
                    </div>
                </div>
                
                <div class="panel" id="bloom-panel">
                    <h2>Bloom Effects</h2>
                    <div class="control-group">
                        <label>
                            <input type="checkbox" id="bloom-checkbox" checked>
                            Enable Bloom
                        </label>
                    </div>
                    <div class="control-group">
                        <label for="bloom-strength">Strength: <span id="bloom-strength-value">1.0</span></label>
                        <input type="range" id="bloom-strength" min="0" max="3" value="1.0" step="0.1">
                    </div>
                    <div class="control-group">
                        <label for="bloom-radius">Radius: <span id="bloom-radius-value">0.4</span></label>
                        <input type="range" id="bloom-radius" min="0.001" max="1" value="0.4" step="0.001">
                    </div>
                    <div class="control-group">
                        <label for="bloom-threshold">Threshold: <span id="bloom-threshold-value">0.0</span></label>
                        <input type="range" id="bloom-threshold" min="0" max="1" value="0" step="0.05">
                    </div>
                </div>
                
                <div class="panel">
                    <h2>Scene</h2>
                    <div class="control-group">
                        <label>
                            <input type="checkbox" id="show-bh-checkbox" checked>
                            Show Black Hole
                        </label>
                    </div>
                    <div class="control-group">
                        <label>
                            <input type="checkbox" id="show-axes-checkbox" checked>
                            Show Axes
                        </label>
                    </div>
                    <div class="control-group">
                        <label>
                            <input type="checkbox" id="show-skybox-checkbox" checked>
                            Show Skybox
                        </label>
                    </div>
                </div>

                <div class="panel">
                    <h2>Statistics</h2>
                    <div class="stats-display">
                        <table id="stats-table">
                            <tr><td>Particles:</td><td id="stat-particles">0</td></tr>
                            <tr><td>BH Mass:</td><td id="stat-bh-mass">-</td></tr>
                            <tr><td>Event Horizon:</td><td id="stat-event-horizon">-</td></tr>
                            <tr><td>Total Mass:</td><td id="stat-mass">0.0</td></tr>
                            <tr><td>Total Energy:</td><td id="stat-energy">0.0</td></tr>
                            <tr><td>Min Density:</td><td id="stat-rho-min">0.0</td></tr>
                            <tr><td>Max Density:</td><td id="stat-rho-max">0.0</td></tr>
                            <tr><td>Min Temp:</td><td id="stat-temp-min">0.0</td></tr>
                            <tr><td>Max Temp:</td><td id="stat-temp-max">0.0</td></tr>
                        </table>
                    </div>
                </div>

                <div class="panel">
                    <h2>Camera</h2>
                    <div class="control-group">
                        <button id="reset-camera-btn" class="btn">Reset View</button>
                        <button id="top-view-btn" class="btn">Top View</button>
                        <button id="side-view-btn" class="btn">Side View</button>
                    </div>
                    <div class="control-group">
                        <label for="move-speed">Move Speed: <span id="move-speed-value">0.5</span></label>
                        <input type="range" id="move-speed" min="0.1" max="5" value="0.5" step="0.1">
                    </div>
                    <small>W/S: Fwd/Back | A/D: Left/Right<br>Q/E: Rotate | Shift/Ctrl: Up/Down</small>
                </div>

                <div class="panel">
                    <h2>Export</h2>
                    <div class="control-group">
                        <button id="screenshot-btn" class="btn">üì∑ Screenshot</button>
                        <button id="export-json-btn" class="btn" disabled>üíæ Export JSON</button>
                    </div>
                    <div class="control-group">
                        <button id="clear-cache-btn" class="btn btn-warning">üóëÔ∏è Clear Disk Cache</button>
                    </div>
                </div>
            </aside>

            <!-- Center: 3D Canvas -->
            <main id="canvas-container">
                <canvas id="three-canvas"></canvas>

                <!-- Overlay info -->
                <div id="info-overlay">
                    <p id="loading-message">Load data to begin visualization</p>
                    <div id="fps-counter">FPS: <span id="fps-counter-value">0</span></div>
                </div>
                
                <!-- Show header button (when hidden) -->
                <button id="show-header-btn" class="show-header-btn" style="display:none;">‚ò∞ Show Header</button>
            </main>
        </div>

        <!-- Footer -->
        <footer>
            <p>TDE-SPH Web Visualizer | Powered by Three.js and WebGL | <a href="https://github.com/your-repo/tde-sph" target="_blank">GitHub</a></p>
        </footer>
    </div>

    <!-- Application scripts -->
    <script src="js/data_loader.js"></script>
    <script src="js/streaming_loader.js"></script>
    <script src="js/interpolation.js"></script>
    <script src="js/visualizer.js"></script>
    <script src="js/visualizer3d.js"></script>
    <script src="js/app.js"></script>
</body>
</html>
